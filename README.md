<img align="left" src="./node-mongo-express.svg" width="480"  />

<div>
  <a href="https://www.wednesday.is?utm_source=gthb&utm_medium=repo&utm_campaign=node-mongo-express" align="left" style="margin-left: 0;">
    <img src="https://uploads-ssl.webflow.com/5ee36ce1473112550f1e1739/5f5879492fafecdb3e5b0e75_wednesday_logo.svg">
  </a>
  <p>
    <h1 align="left">Node Mongo Express
    </h1>
  </p>

  <p>
An enterprise Mongo-Express REST API built using nodejs showcasing - Testing Strategy, mongoDB sharding, models, a REST API Interface, support for Redis, aggregation queries, aggregation caching, circuit-breakers, slack integration, RBAC, rate limited APIs and multi-container queues and schedulers.
  </p>

---

  <p>
    <h4>
      Expert teams of digital product strategists, developers, and designers.
    </h4>
  </p>

  <div>
    <a href="https://www.wednesday.is/contact-us?utm_source=gthb&utm_medium=repo&utm_campaign=serverless" target="_blank">
      <img src="https://uploads-ssl.webflow.com/5ee36ce1473112550f1e1739/5f6ae88b9005f9ed382fb2a5_button_get_in_touch.svg" width="121" height="34">
    </a>
    <a href="https://github.com/wednesday-solutions/" target="_blank">
      <img src="https://uploads-ssl.webflow.com/5ee36ce1473112550f1e1739/5f6ae88bb1958c3253756c39_button_follow_on_github.svg" width="168" height="34">
    </a>
  </div>

---

<span>Weâ€™re always looking for people who value their work, so come and join us. <a href="https://www.wednesday.is/hiring">We are hiring!</a></span>

</div>

<!-- # node-mongo-express


A basic starter for a web app with node, express and mongoose -->

[![Node Mongo Express CI](https://github.com/wednesday-solutions/node-mongo-express/actions/workflows/ci.yml/badge.svg)](https://github.com/wednesday-solutions/node-mongo-express/actions/workflows/ci.yml)

[![Node Mongo Express CD](https://github.com/wednesday-solutions/node-mongo-express/actions/workflows/cd.yml/badge.svg)](https://github.com/wednesday-solutions/node-mongo-express/actions/workflows/cd.yml)

---

<div>
<img src='./badges/badge-statements.svg' height="20"/>
<img src='./badges/badge-branches.svg' height="20"/>
</div>
<div>
<img src='./badges/badge-lines.svg'  height="20"/>
<img src='./badges/badge-functions.svg' height="20"/>
</div>

---

## Pre-requisites

    - yarn
    - docker

## Features

    - Mongo support
    - Docker support
    - Rate limited APIs
    - RBAC middleware using Auth0
    - Sharding mongoDB collection support
    - Paginated APIs
    - Autogenerated APIs from mongoose models
    - Built in slack alerting mecchanism
    - Suport for redis cache
    - Support for aggregate caching
    - Support for batch jobs in multi-container environment
    - Support for circuit breakers
    - Autogenerated swagger documentation
    - Load testing using k6

## Running Load tests

- [Install](https://k6.io/docs/getting-started/installation/) k6
- Execute the following command: `k6 run __tests__/__load__/script.js`
## Build and run docker container locally

    - docker-compose down
    - docker-compose build
    - docker-compose up

# Shard setup

Run the following script

```
./setup-shards/scripts/setup/base.sh
```

Take a look at [this](./setup-shards/README.md) to create shards and replica sets.

## Seeders

Run the following command to begin seeding

```
./seeders/seed.sh
```

## How to start

    - cd `node-mongo-express`
    - yarn
    - ./setup-shards/scripts/setup/base.sh
    - cp .env.example .env.local
    - ./seeders/seed.sh
    - yarn start
    - open browser to `localhost:9000` (port default to 9000)

## API Documentation

Once you've to the server started check out the api documentation at [/api-docs](http://localhost:9000/api-docs)

## Navigating the code base

-   The entry point of the application is the [server/index.js](./server/index.js)
-   The server/app.js imports the APIs from [server/api/index.js](./server/api/index.js)
-   All the different APIs in the [server/api](./server/api) are registered [here](./server/api/index.js)
-   MongoDB is used to store data & mongoose is used as the ORM
    -   [mongo](./server/database/mongo.js)
    -   [models](./server/database/models/)
-   The template has support for the following middlewares
    -   [auth](./server/middlewares/auth/)
    -   [injectRequestId](./server/middlewares/injectRequestId)
    -   [rateLimiter](./server/middlewares/rateLimiter)
-   The template has inbuilt support for
    -   [redis](./server/services/redis.js)
    -   [circuitBreakers](./server/services/circuitBreaker.js)
    -   [slack alerts](./server/utils/slackNotify.js)
    -   [docker](./Dockerfile)
    -   [docker-compose](./docker-compose.yml)
    -   [auto generated apis](./server/api/requestGenerators.js)
    -   [sharding of collections](./setup-shards)
    -   [aggregate caching](./server/api/aggregate/)

## Philosophy

When using NoSQLs you are optimising for read performance. We're doing this by denormalising data. There are multiple copies of the same data. For example

-   Orders contains purchasedProducts which contains Products. Instead of referencing here we embed
-   SupplierProducts contains embedded objects for both Suppliers and Products
-   StoreProducts contains embedded objects for both Stores and Products

This makes our application write heavy. Every time there is a change to a product we need to make a change to

-   SupplierProducts
-   StoreProducts
-   Products

Orders is not impacted since a change in the product after purchase will not affect the order.

However the application is able to perform extremely fast reads. 2 reasons for better performance is

-   shards
-   document embedding

NoSQLs are also good for handling large volumes of data. This is supported due to its ability to have shards. In this application we create 4 shards and the data is distributed amongst these shards.

These are the shard keys that we use

-   \_id
    -   Order
-   name
    -   Products
    -   Suppliers
    -   Stores
        <br/>We got really good distribution across shards(24-26%) per shard after seeding 4 million records. It's possible to get a hot shard due to this but we're yet to see that.
-   productId
    -   SupplierProducts
    -   StoreProducts
        <br/>productId is chosen as the shard key since we anticipate that the queries for fetching all suppliers/stores that sell a particular product will be much more than fetching all products of a supplier/store.
